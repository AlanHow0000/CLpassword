<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LinguaLab ‚Äì Practice English with AI</title>
  <meta name="description" content="Scenario-based English practice with AI conversations. Daily English and Workplace English." />
  <style>
    :root{
      --bg:#0b1020;--card:#121936;--muted:#9aa4c7;--text:#e6e9f7;
      --accent:#6e9cff;--accent-2:#8ef0d0;--danger:#ff7a7a;--shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:radial-gradient(1000px 600px at 80% -10%,#1a2460,transparent),
                 radial-gradient(800px 600px at -10% 20%,#1b3b42,transparent),
                 var(--bg);color:var(--text)
    }
    header{position:sticky;top:0;backdrop-filter:blur(10px);background:rgba(9,11,24,.6);
      border-bottom:1px solid rgba(255,255,255,.05);z-index:50}
    .container{max-width:1120px;margin:0 auto;padding:16px}
    .nav{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.3px}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
    .pill{padding:6px 12px;border:1px solid rgba(255,255,255,.1);border-radius:999px;color:var(--muted);font-size:14px}

    .hero{padding:56px 16px 20px}
    .hero-grid{display:grid;grid-template-columns:1.2fr .8fr;gap:24px;align-items:start}
    @media (max-width:900px){.hero-grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card.pad{padding:22px}
    h1{font-size:clamp(28px,5vw,48px);margin:0 0 10px;line-height:1.1}
    .sub{color:var(--muted);font-size:clamp(14px,2.2vw,18px)}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:18px}
    .stat{padding:14px;border-radius:14px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);text-align:center}
    .stat .big{font-weight:800;font-size:22px}
    .stat .cap{color:var(--muted);font-size:12px}
    .scenarios{padding:26px 16px 60px}
    .section-title{display:flex;align-items:center;justify-content:space-between;margin:18px 0 10px}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:16px}
    @media (max-width:1200px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .scenario{position:relative;overflow:hidden;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease}
    .scenario:hover{transform:translateY(-4px);box-shadow:0 18px 40px rgba(0,0,0,.35)}
    .thumb{aspect-ratio:16/11;background:#0e1430;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;font-size:42px}
    .scenario h3{margin:14px 16px 6px;font-size:16px}
    .scenario p{margin:0 16px 14px;color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:0;cursor:pointer;padding:11px 14px;border-radius:12px;font-weight:700;color:#0d142e;background:linear-gradient(180deg,var(--accent),#5f7df5);box-shadow:var(--shadow)}
    .btn.secondary{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.1);font-weight:600}
    .btn.ghost{background:transparent;color:var(--muted);border:1px dashed rgba(255,255,255,.2)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .input{padding:11px 12px;border-radius:12px;background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.1)}
    .input::placeholder{color:#b8c0e0}
    .progress{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.1)}
    .progress>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .3s ease}
    .notice{font-size:13px;color:var(--muted)}
    footer.site{padding:36px 16px 60px;color:var(--muted);text-align:center}
    .badge{font-size:12px;color:#0a122c;background:var(--accent-2);padding:4px 8px;border-radius:999px;font-weight:700}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
    .modal{width:min(100%,980px);max-height:92vh;display:grid;grid-template-rows:auto 1fr auto;background:var(--card);border-radius:20px;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow)}
    .modal header{position:sticky;top:0;background:rgba(18,25,54,.85);border-bottom:1px solid rgba(255,255,255,.06);padding:8px 12px}
    .modal .hdr{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modal .hdr-left{display:flex;gap:8px;align-items:center}
    .modal .timer{font-weight:700;padding:4px 8px;border-radius:10px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1);min-width:74px;text-align:center}
    .modal .body{padding:0;overflow:auto;background:#0b112d}
    .modal iframe{display:block;width:100%;height:72vh;border:0;background:#0b112d}
    .modal footer{padding:10px 12px;display:flex;gap:10px;justify-content:space-between;align-items:center}
    .soft{color:var(--muted);font-size:12px}

    /* Toast + Confetti */
    .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#121936;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;color:var(--text);box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}
    .confetti{pointer-events:none;position:fixed;inset:0;overflow:hidden;z-index:9999}
    .confetti i{position:absolute;width:8px;height:14px;background:linear-gradient(180deg,var(--accent),var(--accent-2));opacity:.9;will-change:transform,opacity}
    @keyframes fall{to{transform:translateY(105vh) rotate(360deg);opacity:0}}

    /* Auth full screen */
    #app{display:none}
    #authScreen{
      position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;
      padding:24px;
      background:
        radial-gradient(1200px 800px at 120% -10%, #20327f 0%, transparent 60%),
        radial-gradient(1000px 900px at -10% 10%, #115a6a 0%, transparent 60%),
        linear-gradient(180deg,#0b1020,#0b1020);
    }
    .auth-wrap{width:min(960px,100%);display:grid;grid-template-columns:1.1fr .9fr;gap:24px}
    @media (max-width:900px){.auth-wrap{grid-template-columns:1fr}}
    .auth-hero{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:28px;box-shadow:var(--shadow)}
    .auth-hero h1{margin:0 0 10px;font-size:clamp(26px,4.5vw,42px)}
    .auth-hero p{margin:0;color:var(--muted)}
    .auth-card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.1);border-radius:18px;padding:24px;box-shadow:var(--shadow);display:grid;gap:12px}
    .auth-card h3{margin:0 0 4px}
    .auth-error{font-size:13px;background:rgba(255,0,0,.08);border:1px solid rgba(255,100,100,.4);padding:8px 10px;border-radius:10px;color:#ffdede;display:none}
    .auth-small{font-size:12px;color:var(--muted)}
    .auth-row{display:grid;gap:10px}
    .auth-actions{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>

  <!-- FULL SCREEN AUTH -->
  <section id="authScreen">
    <div class="auth-wrap">
      <div class="auth-hero">
        <div class="brand" style="margin-bottom:10px;">
          <div class="logo" aria-hidden="true"></div>
          <div style="font-weight:800">LinguaLab</div>
          <span class="pill">AI English Practice</span>
        </div>
        <h1>Sign in to start practicing</h1>
        <p>Log in with your email and password. Your points, streak, and progress are saved to your account.</p>
        <ul style="margin:14px 0 0 18px; color:var(--muted); line-height:1.9;">
          <li>Practice realistic conversations (restaurant, interview, travel and more)</li>
          <li>Earn points, keep a streak, unlock weekly bonuses</li>
          <li>Use mic on Chrome + HTTPS for best results</li>
        </ul>
      </div>

      <div class="auth-card">
        <h3>Welcome back!</h3>
        <div class="auth-row">
          <input id="authName" class="input" placeholder="Full name (for profile)" />
          <input id="authEmail" class="input" placeholder="Email" type="email" />
          <input id="authPass" class="input" placeholder="Password (min 6 chars)" type="password" />
        </div>
        <div id="authError" class="auth-error" role="alert"></div>
        <div class="auth-actions">
          <button class="btn" id="loginBtn">Log in</button>
          <button class="btn secondary" id="signupBtn">Create account</button>
        </div>
        <div class="auth-small">Tip: Use a real email so you can use multiple devices.</div>
      </div>
    </div>
  </section>
  <!-- /AUTH -->

  <!-- APP (hidden until logged in) -->
  <div id="app">
    <header>
      <div class="container nav">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>LinguaLab</div>
          <span class="pill">AI English Practice</span>
        </div>
        <div class="row">
          <input id="studentName" class="input" placeholder="Your name (for points & streak)" />
          <button class="btn secondary" id="saveNameBtn">Save</button>
          <button class="btn secondary logout" id="logoutBtn" style="margin-left:8px;">Log out</button>
        </div>
      </div>
    </header>

    <section class="hero">
      <div class="container hero-grid">
        <div class="card pad">
          <h1>Practice real-life English with AI</h1>
          <p class="sub">Pick a scenario, practice for ~10 minutes, and mark it completed to earn points. Keep your streak going!</p>

          <div class="stats">
            <div class="stat"><div class="big" id="points">0</div><div class="cap">Points</div></div>
            <div class="stat"><div class="big" id="streak">0</div><div class="cap">Day Streak</div></div>
            <div class="stat"><div class="big" id="completed">0</div><div class="cap">Scenarios Done</div></div>
          </div>

          <div style="margin-top:16px">
            <div class="progress" aria-label="Level progress"><span id="levelBar" style="width:0%"></span></div>
            <div class="row" style="justify-content:space-between; margin-top:8px;">
              <span class="notice">Level <b id="level">1</b></span>
              <span class="notice">Next level at <b id="nextLevelAt">100</b> pts</span>
            </div>
          </div>

          <div class="panel" style="margin-top:16px">
            <div class="row">
              <button class="btn" id="resumeBtn">Resume last scenario</button>
              <button class="btn ghost" id="resetBtn" title="Reset your progress">Reset progress</button>
            </div>
            <span class="notice">Your progress is saved to your account.</span>
          </div>
        </div>

        <!-- Challenges -->
        <div class="card pad">
          <h3 style="margin:6px 0 10px">Challenges</h3>
          <div id="challenges" class="panel" style="gap:10px">
            <div class="row" style="justify-content:space-between">
              <div><b>Daily</b>: Finish any scenario <span class="soft">(bonus +20)</span></div>
              <div id="dailyStatus" class="pill">Not done</div>
            </div>
            <div class="row" style="justify-content:space-between">
              <div><b>Weekly</b>: Complete 5 different scenarios <span class="soft">(bonus +100)</span></div>
              <div id="weeklyStatus" class="pill">0 / 5</div>
            </div>
            <div class="soft">Bonuses are added automatically when you click ‚ÄúMark Completed‚Äù.</div>
          </div>
        </div>
      </div>
    </section>

    <section class="scenarios">
      <div class="container">
        <div class="section-title"><h2 style="margin:0">Daily English (5)</h2></div>
        <div class="grid">
          <div class="card scenario" data-scenario="ordering"><div class="thumb">üçù</div><h3>Ordering Food</h3><p>Order food & drinks, ask for recommendations, confirm the bill.</p></div>
          <div class="card scenario" data-scenario="appointment"><div class="thumb">üìÖ</div><h3>Making an Appointment</h3><p>Book, confirm or reschedule a clinic/salon/business appointment.</p></div>
          <div class="card scenario" data-scenario="telephone"><div class="thumb">üìû</div><h3>Telephone Talk</h3><p>Ask for someone, clarify on a bad line, confirm details.</p></div>
          <div class="card scenario" data-scenario="travel"><div class="thumb">‚úàÔ∏è</div><h3>Travel</h3><p>Flights, hotels, baggage, cancellations, itinerary & changes.</p></div>
          <div class="card scenario" data-scenario="smalltalks"><div class="thumb">üí¨</div><h3>Small Talks</h3><p>Open questions, reconnect, light topics, polite closing.</p></div>
        </div>

        <div class="section-title" style="margin-top:26px;"><h2 style="margin:0">Workplace English (5)</h2></div>
        <div class="grid">
          <div class="card scenario" data-scenario="interview"><div class="thumb">üíº</div><h3>Interview</h3><p>STAR answers, strengths, value-add, pressure & mistakes.</p></div>
          <div class="card scenario" data-scenario="negotiating"><div class="thumb">ü§ù</div><h3>Negotiating</h3><p>Proposals, counters, meet-in-the-middle, polite rejection.</p></div>
          <div class="card scenario" data-scenario="networking"><div class="thumb">üßë‚Äçü§ù‚Äçüßë</div><h3>Networking</h3><p>Open questions, highlights, plans, swap contacts.</p></div>
          <div class="card scenario" data-scenario="presentation"><div class="thumb">üé§</div><h3>Presentation (Signposting)</h3><p>Openers, transitions, examples, clear close.</p></div>
          <div class="card scenario" data-scenario="prospects"><div class="thumb">üìà</div><h3>Talking to Prospects</h3><p>Discovery, objections, and next steps with a buyer.</p></div>
        </div>
      </div>
    </section>

    <!-- Modal with embedded Voiceflow -->
    <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal">
        <header>
          <div class="container hdr">
            <div class="hdr-left">
              <strong id="modalTitle">Scenario</strong>
              <span id="scenarioBadge" class="pill"></span>
              <span id="timer" class="timer">10:00</span>
            </div>
            <div class="row">
              <button class="btn secondary" id="closeModalBtn">Close</button>
              <button class="btn" id="markCompleteBtn" disabled title="Enabled after practice time">Mark Completed</button>
            </div>
          </div>
        </header>
        <div class="body">
          <iframe id="vfFrame" src="about:blank" allow="microphone; clipboard-read; clipboard-write;" title="Voiceflow Chat"></iframe>
        </div>
        <footer><span class="soft">Tip: If the mic is missing, check browser permissions.</span></footer>
      </div>
    </div>

    <!-- Toast + Confetti -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div id="confetti" class="confetti" aria-hidden="true"></div>

    <footer class="site">
      <div class="container">Built as an MVP for English centers. ¬© <span id="year"></span> LinguaLab.</div>
    </footer>
  </div><!-- /#app -->

  <!-- Firebase (modular CDN) + App logic -->
  <script type="module">
    // ===== Firebase SDK (modular) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // --- Your Firebase config (you provided this) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAVSux-JUn8tmQA5jqCy9clWzYRgBkNZwU",
      authDomain: "cl-english.firebaseapp.com",
      projectId: "cl-english",
      storageBucket: "cl-english.firebasestorage.app",
      messagingSenderId: "629186632292",
      appId: "1:629186632292:web:d65ddde473f771f0d35d71"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db   = getFirestore(appFB);

    // ============================
    // üîß Voiceflow project IDs
    // ============================
    const VF_PROJECT = {
      ordering:    '68985df43b90d9d386b3e573',
      appointment: '689af5bc3b90d9d386b4b06f',
      telephone:   '689af8fe3b90d9d386b4b1c9',
      travel:      '689b05df3b90d9d386b4b87f',
      smalltalks:  '689b0e5c3b90d9d386b4ba66',
      interview:   '689b2fa13b90d9d386b4c4f5',
      negotiating: '689b32823b90d9d386b4c5e2',
      networking:  '689b35373b90d9d386b4c76a',
      presentation:'689b376e9f2f40a7aa3ea337',
      prospects:   '689b3ef19f2f40a7aa3ea834',
    };

    // ============================
    // ‚öôÔ∏è Config
    // ============================
    const POINTS_PER_COMPLETION = 50;
    const GATE_SECONDS = 240;       // 4 minutes before "Mark Completed" auto-enables
    const SESSION_SECONDS = 600;    // 10 minute soft timer
    const DAILY_BONUS = 20;
    const WEEKLY_BONUS = 100;
    const WEEK_TARGET = 5;

    // ============================
    // üß† State (local + cloud)
    // ============================
    const state = {
      uid: null,
      name: localStorage.getItem('ll_name') || '',
      points: Number(localStorage.getItem('ll_points') || 0),
      completedCount: Number(localStorage.getItem('ll_completed') || 0),
      lastScenario: localStorage.getItem('ll_lastScenario') || '',
      lastActiveDate: localStorage.getItem('ll_lastDate') || '',
      streak: Number(localStorage.getItem('ll_streak') || 0),
      sessionStart: 0, timerId: null,
    };

    // Level math
    function pointsForLevel(level){ if (level<=1) return 0; let total=0, base=100; for(let i=1;i<level;i++){ total+=base; base=Math.round(base*1.2);} return total; }
    function currentLevel(points){ let L=1; while(points>=pointsForLevel(L+1)) L++; return L; }

    // UI refs
    const $ = id => document.getElementById(id);
    const el = {
      app: $('app'), authScreen: $('authScreen'),
      points: $('points'), streak: $('streak'), completed: $('completed'),
      level: $('level'), levelBar: $('levelBar'), nextLevelAt: $('nextLevelAt'),
      resumeBtn: $('resumeBtn'), resetBtn: $('resetBtn'),
      saveNameBtn: $('saveNameBtn'), nameInput: $('studentName'),
      year: $('year'),
      backdrop: $('modalBackdrop'), title: $('modalTitle'), badge: $('scenarioBadge'),
      frame: $('vfFrame'), closeBtn: $('closeModalBtn'), markBtn: $('markCompleteBtn'), timer: $('timer'),
      dailyStatus: $('dailyStatus'), weeklyStatus: $('weeklyStatus'),
      toast: $('toast'), confetti: $('confetti'),
      authName: $('authName'), authEmail: $('authEmail'), authPass: $('authPass'),
      loginBtn: $('loginBtn'), signupBtn: $('signupBtn'), authError: $('authError'),
      logoutBtn: $('logoutBtn'),
    };

    const pad = n => String(n).padStart(2,'0');
    const fmtDate = d => d.toISOString().slice(0,10);

    // Persist local
    function persistLocal(){
      localStorage.setItem('ll_name', state.name);
      localStorage.setItem('ll_points', String(state.points));
      localStorage.setItem('ll_completed', String(state.completedCount));
      localStorage.setItem('ll_lastScenario', state.lastScenario);
      localStorage.setItem('ll_lastDate', state.lastActiveDate);
      localStorage.setItem('ll_streak', String(state.streak));
    }

    // Debounced cloud save
    let saveTimer=null;
    async function persistCloud(){
      if (!state.uid) return;
      clearTimeout(saveTimer);
      saveTimer = setTimeout(async ()=>{
        try{
          await setDoc(doc(db, 'users', state.uid), {
            name: state.name,
            points: state.points,
            completedCount: state.completedCount,
            lastScenario: state.lastScenario,
            lastActiveDate: state.lastActiveDate,
            streak: state.streak,
            updatedAt: serverTimestamp(),
          }, { merge: true });
        }catch(e){ console.warn('save failed', e); }
      }, 300);
    }

    function render(){
      el.points.textContent = state.points;
      el.streak.textContent = state.streak;
      el.completed.textContent = state.completedCount;
      const lvl = currentLevel(state.points);
      el.level.textContent = lvl;
      const next = pointsForLevel(lvl+1), prev = pointsForLevel(lvl);
      el.nextLevelAt.textContent = next;
      const width = Math.max(2, Math.min(100, Math.round(((state.points - prev)/(next - prev))*100)));
      el.levelBar.style.width = width + '%';
      el.resumeBtn.disabled = !state.lastScenario;
      el.year.textContent = new Date().getFullYear();
      el.nameInput.value = state.name;
      renderChallenges();
      el.logoutBtn.style.display = state.uid ? '' : 'none';
    }

    // üî• Streak
    function updateStreakOnActivity(){
      const today = fmtDate(new Date());
      if (!state.lastActiveDate){ state.streak = 1; }
      else {
        const diff = Math.round((new Date(today) - new Date(state.lastActiveDate))/(1000*60*60*24));
        if (diff === 1) state.streak += 1;
        else if (diff > 1) state.streak = 1;
      }
      state.lastActiveDate = today;
    }

    // ===== Challenges (local-only) =====
    function weekStartStr(d=new Date()){
      const dt = new Date(d);
      const day = (dt.getDay()+6)%7; dt.setHours(0,0,0,0); dt.setDate(dt.getDate()-day);
      return dt.toISOString().slice(0,10);
    }
    function getWeekSet(){
      const id = weekStartStr();
      const key = 'll_weekSet_'+id;
      const raw = localStorage.getItem(key);
      return { id, key, set: new Set(raw ? JSON.parse(raw) : []) };
    }
    function setWeekSet(ws){ localStorage.setItem(ws.key, JSON.stringify([...ws.set])); }
    function weeklyAwarded(){ return localStorage.getItem('ll_weekAwarded_'+weekStartStr()) === '1'; }
    function setWeeklyAwarded(){ localStorage.setItem('ll_weekAwarded_'+weekStartStr(), '1'); }
    function dailyAwardedToday(){ return localStorage.getItem('ll_dailyBonusDate') === fmtDate(new Date()); }
    function setDailyAwardedToday(){ localStorage.setItem('ll_dailyBonusDate', fmtDate(new Date())); }
    function renderChallenges(){
      el.dailyStatus.textContent = dailyAwardedToday() ? 'Done ‚úì' : 'Not done';
      const ws = getWeekSet(); const count = ws.set.size;
      el.weeklyStatus.textContent = (weeklyAwarded() ? 'Completed ‚úì' : `${count} / ${WEEK_TARGET}`);
    }

    // ===== Voiceflow in iframe =====
    function recreateVFFrame() {
      const old = el.frame;
      const fresh = document.createElement('iframe');
      fresh.id = 'vfFrame'; fresh.title = 'Voiceflow Chat';
      fresh.src = 'about:blank';
      fresh.setAttribute('allow', 'microphone; clipboard-read; clipboard-write;');
      old.parentNode.replaceChild(fresh, old);
      el.frame = fresh; return fresh;
    }
    function loadVFInIframe(projectID){
      const doc = el.frame.contentWindow.document;
      const html = `
<!DOCTYPE html><html><head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body{margin:0;height:100%;background:#0b112d;color:#e6e9f7;font-family:Inter,system-ui,Arial}
  .vfrc-launcher{display:none !important;}
  .vfrc-widget{position: static !important; inset:auto !important; margin:18px auto !important; box-shadow:none !important;
    width:min(900px,96%) !important; height:calc(100vh - 36px) !important; border-radius:16px !important;}
  .vfrc-chat,.vfrc-widget__container{height:100% !important; max-height:none !important;}
</style>
</head><body>
<script type="text/javascript">
(function(d,t){
  var v=d.createElement(t); v.type="text/javascript"; v.src="https://cdn.voiceflow.com/widget-next/bundle.mjs";
  v.onload=function(){
    try{
      window.voiceflow.chat.load({
        verify:{ projectID:"${projectID}" },
        url:"https://general-runtime.voiceflow.com",
        versionID:"production",
        voice:{ url:"https://runtime-api.voiceflow.com" }
      });
      window.voiceflow.chat.open?.(); setTimeout(()=>window.voiceflow.chat.open?.(), 600);
    }catch(e){ console.error(e); }
  }; (d.head||d.body).appendChild(v);
})(document,"script");
<\/script>
</body></html>`;
      doc.open(); doc.write(html); doc.close();
    }

    const scenarioMeta = {
      ordering:{ title:'Ordering Food', badge:'Daily' }, appointment:{ title:'Making an Appointment', badge:'Daily' },
      telephone:{ title:'Telephone Talk', badge:'Daily' }, travel:{ title:'Travel', badge:'Daily' },
      smalltalks:{ title:'Small Talks', badge:'Daily' }, interview:{ title:'Interview', badge:'Workplace' },
      negotiating:{ title:'Negotiating', badge:'Workplace' }, networking:{ title:'Networking', badge:'Workplace' },
      presentation:{ title:'Presentation (Signposting)', badge:'Workplace' }, prospects:{ title:'Talking to Prospects', badge:'Workplace' },
    };

    // Timer + gating
    function startTimer(){ stopTimer(); state.sessionStart = Date.now(); el.markBtn.disabled = true; tickTimer(); state.timerId = setInterval(tickTimer, 1000); }
    function stopTimer(){ if (state.timerId){ clearInterval(state.timerId); state.timerId = null; } }
    function secondsSinceStart(){ return state.sessionStart ? Math.floor((Date.now() - state.sessionStart) / 1000) : 0; }
    function tickTimer(){ const e=secondsSinceStart(), r=Math.max(0,SESSION_SECONDS-e); el.timer.textContent = `${pad(Math.floor(r/60))}:${pad(r%60)}`; el.markBtn.disabled = !(e>=GATE_SECONDS); }

    // Open/close scenario (requires login)
    function openScenario(key){
      if (!state.uid){ showLogin(); return; }
      const meta = scenarioMeta[key]; const id = VF_PROJECT[key]; if(!meta||!id) return;
      state.lastScenario = key; persistLocal(); persistCloud();
      el.title.textContent = meta.title; el.badge.textContent = meta.badge;
      el.backdrop.style.display = 'flex'; recreateVFFrame(); loadVFInIframe(id); startTimer();
      updateStreakOnActivity(); persistLocal(); persistCloud(); render();
    }
    function closeModal(){ el.backdrop.style.display = 'none'; stopTimer(); }

    // Toast + confetti
    function showToast(msg){ el.toast.textContent = msg; el.toast.classList.add('show'); setTimeout(()=> el.toast.classList.remove('show'), 1600); }
    function burstConfetti(){
      const c = el.confetti; c.innerHTML = '';
      const N = 80;
      for (let i=0;i<N;i++){
        const p = document.createElement('i');
        const left = Math.random()*100, dur = 0.9 + Math.random()*0.8, delay = Math.random()*0.2, rotate = Math.random()*360;
        p.style.left = left+'vw'; p.style.top = '-20px'; p.style.transform = `rotate(${rotate}deg)`;
        p.style.animation = `fall ${dur}s cubic-bezier(.2,.7,.2,1) ${delay}s forwards`;
        if (Math.random()<.33) p.style.background = 'linear-gradient(180deg,#FFD66E,#FF8BA7)';
        else if (Math.random()<.66) p.style.background = 'linear-gradient(180deg,#8EF0D0,#6E9CFF)';
        c.appendChild(p);
      }
      setTimeout(()=>{ c.innerHTML=''; }, 1800);
    }

    // Points awarding
    function markCompleted(){
      if (el.markBtn.disabled) return;
      const base = POINTS_PER_COMPLETION;
      const mult = Math.min(2, 1 + 0.1 * (state.streak - 1));
      const streakPct = Math.round((mult - 1) * 100);
      let gained = Math.round(base * mult);
      if (!dailyAwardedToday()){ gained += DAILY_BONUS; setDailyAwardedToday(); }
      const ws = getWeekSet(); ws.set.add(state.lastScenario); setWeekSet(ws);
      if (!weeklyAwarded() && ws.set.size >= WEEK_TARGET){ gained += WEEKLY_BONUS; setWeeklyAwarded(); }
      state.points += gained; state.completedCount += 1;
      persistLocal(); persistCloud(); render();
      burstConfetti(); showToast(`Session saved! +${gained} pts${streakPct>0?` (streak +${streakPct}%)`:''}`);
      setTimeout(closeModal, 1100);
    }

    // Reset + name save
    function resetProgress(){
      if (!confirm('Reset your progress (points, streak, completed, local challenges)?')) return;
      state.points = 0; state.completedCount = 0; state.streak = 0; state.lastActiveDate = '';
      localStorage.removeItem('ll_dailyBonusDate');
      const id = weekStartStr(); localStorage.removeItem('ll_weekSet_'+id); localStorage.removeItem('ll_weekAwarded_'+id);
      persistLocal(); persistCloud(); render(); showToast('Progress reset');
    }
    function saveName(){ state.name = (el.nameInput.value || '').trim(); persistLocal(); persistCloud(); showToast('Saved ‚úì'); }

    // ===== Auth helpers =====
    function showLogin(){ el.authScreen.style.display='flex'; el.app.style.display='none'; el.authEmail.focus(); }
    function showApp(){ el.authScreen.style.display='none'; el.app.style.display='block'; }

    function humanAuthError(code){
      switch(code){
        case 'auth/invalid-email': return 'Please enter a valid email address.';
        case 'auth/missing-password': return 'Please enter your password.';
        case 'auth/user-not-found':
        case 'auth/wrong-password':
        case 'auth/invalid-credential': return 'Incorrect email or password.';
        case 'auth/too-many-requests': return 'Too many attempts. Please wait a moment and try again.';
        case 'auth/email-already-in-use': return 'This email is already registered.';
        case 'auth/weak-password': return 'Password is too weak (min 6 characters).';
        case 'auth/network-request-failed': return 'Network error. Check your connection and try again.';
        default: return 'Something went wrong. Please try again.';
      }
    }
    function showAuthError(msg){ el.authError.textContent = msg; el.authError.style.display='block'; }
    function clearAuthError(){ el.authError.textContent=''; el.authError.style.display='none'; }

    // ===== Auth events =====
    el.loginBtn.addEventListener('click', async()=>{
      clearAuthError();
      try{
        const email=(el.authEmail.value||'').trim(); const pass=el.authPass.value;
        await signInWithEmailAndPassword(auth,email,pass);
      }catch(e){ showAuthError(humanAuthError(e.code)); }
    });
    el.signupBtn.addEventListener('click', async()=>{
      clearAuthError();
      try{
        const name=(el.authName.value||'').trim(); const email=(el.authEmail.value||'').trim(); const pass=el.authPass.value;
        const cred = await createUserWithEmailAndPassword(auth,email,pass);
        if (name) await updateProfile(cred.user,{displayName:name});
        await setDoc(doc(db,'users',cred.user.uid),{
          name, points:0, completedCount:0, streak:0, lastActiveDate:'', lastScenario:'',
          createdAt: serverTimestamp()
        },{merge:true});
      }catch(e){ showAuthError(humanAuthError(e.code)); }
    });

    // Enter key submits login
    [el.authName, el.authEmail, el.authPass].forEach(inp=>{
      inp.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ ev.preventDefault(); el.loginBtn.click(); }});
    });

    el.logoutBtn.addEventListener('click', ()=> signOut(auth));

    onAuthStateChanged(auth, async user=>{
      if(!user){ showLogin(); return; }
      // logged in
      state.uid = user.uid;
      state.name = state.name || user.displayName || '';
      try{
        const snap = await getDoc(doc(db,'users',user.uid));
        if (snap.exists()){
          const d = snap.data();
          state.name = d.name || state.name;
          state.points = d.points ?? state.points;
          state.completedCount = d.completedCount ?? state.completedCount;
          state.lastScenario = d.lastScenario ?? state.lastScenario;
          state.lastActiveDate = d.lastActiveDate ?? state.lastActiveDate;
          state.streak = d.streak ?? state.streak;
          persistLocal();
        } else {
          await setDoc(doc(db,'users',user.uid), {
            name: state.name || user.displayName || '',
            points: state.points, completedCount: state.completedCount,
            lastScenario: state.lastScenario, lastActiveDate: state.lastActiveDate, streak: state.streak,
            createdAt: serverTimestamp()
          }, { merge:true });
        }
      }catch(e){ console.warn('load user doc failed', e); }
      showApp(); render();
    });

    // ===== App events =====
    document.querySelectorAll('.scenario').forEach(card => {
      card.addEventListener('click', ()=> openScenario(card.dataset.scenario));
    });
    $('closeModalBtn').addEventListener('click', closeModal);
    $('markCompleteBtn').addEventListener('click', markCompleted);
    $('resetBtn').addEventListener('click', resetProgress);
    $('saveNameBtn').addEventListener('click', saveName);
    $('resumeBtn').addEventListener('click', ()=> state.lastScenario && openScenario(state.lastScenario));

    // Init
    $('year').textContent = new Date().getFullYear();
    render();
    showLogin(); // show login immediately on first load
  </script>
</body>
</html>
